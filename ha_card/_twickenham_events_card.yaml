type: custom:mushroom-template-card
primary: |
  {% set status_sensor = states('binary_sensor.twickenham_events_status') %}
  {% set next_event = state_attr('sensor.twickenham_events_next', 'event') %}
  {% if status_sensor == 'ON' or next_event == none %}
    Twick Stadium
  {% else %}
    {% if next_event.emoji %}{{ next_event.emoji }} {% endif %}{{ next_event.fixture }}
  {% endif %}
secondary: |
  {% set status_sensor = states('binary_sensor.twickenham_events_status') %}
  {% set next_event = state_attr('sensor.twickenham_events_next', 'event') %}
  {% set event_date_str = state_attr('sensor.twickenham_events_next', 'date') %}

  {% if status_sensor == 'ON' or next_event == none %}
    Check
  {% else %}
    {% set event_date = strptime(event_date_str, '%Y-%m-%d') %}
    {% set today = now().date() %}
    {% set days_diff = (event_date.date() - today).days %}

    {% if days_diff == 0 %}
      {% set day_text = next_event.start_time if next_event.start_time else 'TBC' %}
    {% elif days_diff <= 5 %}
      {% set day_names = ['Mon', 'Tues', 'Weds', 'Thurs', 'Fri', 'Sat', 'Sun'] %}
      {% set day_text = day_names[event_date.weekday()] %}
      {% if next_event.start_time %}
        {% set day_text = day_text + ' ' + next_event.start_time %}
      {% endif %}
    {% else %}
      {% set day_text = event_date.strftime('%d %b') %}
    {% endif %}

    {% if next_event.event_count > 1 %}
      {{ day_text }} â€¢ {{ next_event.event_index }}/{{ next_event.event_count }}
    {% else %}
      {{ day_text }}
    {% endif %}
  {% endif %}
icon: |
  {% set status_sensor = states('binary_sensor.twickenham_events_status') %}
  {% set next_event = state_attr('sensor.twickenham_events_next', 'event') %}
  {% if status_sensor == 'ON' or next_event == none %}
    mdi:alert-circle
  {% elif next_event.icon %}
    {{ next_event.icon }}
  {% else %}
    mdi:stadium
  {% endif %}
entity: sensor.twickenham_events_next
icon_color: |
  {% set status_sensor = states('binary_sensor.twickenham_events_status') %}
  {% set next_event = state_attr('sensor.twickenham_events_next', 'event') %}
  {% set event_date_str = state_attr('sensor.twickenham_events_next', 'date') %}

  {% if status_sensor == 'ON' or next_event == none %}
    red
  {% else %}
    {% set event_date = strptime(event_date_str, '%Y-%m-%d') %}
    {% set today = now().date() %}
    {% set days_diff = (event_date.date() - today).days %}

    {% if days_diff == 0 %}
      green
    {% elif days_diff == 1 %}
      yellow
    {% else %}
      blue
    {% endif %}
  {% endif %}
multiline_secondary: true
fill_container: true
tap_action:
  action: navigate
  navigation_path: "#twickenham-event"
